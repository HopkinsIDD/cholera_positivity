---
title: "Towards estimating true cholera burden: a systematic review and meta-analysis of Vibrio cholerae positivity"
author: "Kirsten E. Wiens, Hanmeng Xu, Kaiyue Zou, John Mwaba, Justin Lessler, Espoir B. Malembaka, Maya N. Demby, Godfrey Bwire, Firdausi Qadri, Elizabeth C. Lee, Andrew S. Azman"
output: 
  html_document:
    toc: true
    toc_float: true
---


<br>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE,
                      dev=c('png', 'pdf'), fig.path='figures/')
knitr::opts_knit$set(root.dir = here::here())
```

```{r preamble, warning = TRUE, message = FALSE}
# packages
pacman::p_load('tidyverse', 'data.table', 'readxl',
               'stringr', 'lubridate', 'reshape2',
               'boot', 'RVAideMemoire', 'meta', 
               'sf', 'raster', 'countrycode',
               'ggplot2', 'RColorBrewer', 'cowplot',
               'kableExtra', 'flextable', 'scales',
               'doParallel', 'foreach')

# custom functions
source(here::here('code', 'utils.R'))

# JAGS settings
jags_run_id <- 'jags-cd'

# set random seed
set.seed(7341)
```

```{r load-clean-data, include = FALSE}
# shapefile
shp <- st_read(here::here('data/shapefiles/ne_50m_admin_0_countries/ne_50m_admin_0_countries.shp'))
shp <- shp %>% dplyr::select(ISO_A3, NAME_SORT, geometry)

#  load data
df_all <- read.csv(here::here('data', 'extracted_data', 'cc_extractions.csv'))
vars <- read.csv(here::here('data', 'extracted_data', 'extraction_variables.csv'))

# set column variable names
names(df_all) <- gsub('\\.', ' ', names(df_all))
df_all <- relocate(df_all, vars$Variable.label)
names(df_all) <- vars$Variable
df_all <- df_all[!is.na(names(df_all))]

# format columns
df_all <- df_all %>%
  # primary dataset
  filter(primary==1) %>%
  # dates
  mutate(outbreak_L = as.Date(outbreak_L, format = c('%d-%B-%Y')),
         outbreak_R = as.Date(outbreak_R, format = c('%d-%B-%Y')),
         TL = as.Date(TL, format = c('%d-%B-%Y')),
         TR = as.Date(TR, format = c('%d-%B-%Y'))) %>%
  # remove variable name text in parentheses and set factor levels
  mutate(study_design = gsub('\\s*\\([^\\)]+\\)', '', study_design),
         sampling_approach = gsub('\\s*\\([^\\)]+\\)', '', sampling_approach),
         study_design = factor(study_design, 
                               levels = c('Diagnostic test accuracy',
                                          'Vaccine effectiveness',
                                          'Surveillance', 'Other')),
         sampling_approach = factor(sampling_approach, 
                                    levels = c('All suspected cases', 'Systematic',
                                               'Simple random', 'Other', 
                                               'Convenience', 'Unknown')),
         sampling_quality = ifelse(sampling_approach %in% c('All suspected cases', 
                                                            'Systematic',
                                                            'Simple random'),
                                      'High', 'Low'),
         cases_dehydrated = ifelse(cases_dehydrated == 1, 'Yes', 'No')) %>%
  # region as defined by World Bank Development Indicators
  mutate(region = countrycode(country_iso3, 
                              origin = 'iso3c', 
                              destination = 'region')) %>%
  mutate(region = ifelse(region != 'Sub-Saharan Africa',
                         region, 
                         countrycode(country_iso3, 
                                     origin = 'iso3c', 
                                     destination = 'region23'))) %>%
  # surveillance is outbreak or non-outbreak
  mutate(surveillance_type = ifelse(surveillance_type == 'Outbreak surveillance',
                                    'Outbreak', 'Non-outbreak')) %>%
  # binary version of age variable
  mutate(cases_min_age_bin = ifelse(cases_min_age == 0, 0, 1)) %>%
  # remove incomplete extractions
  filter(!is.na(sampling_approach))

# admin name editing (to match the shapefiles)
df_all <- edit_admin_names(df_all)
```

```{r match-polygons}
# match each entry_id to a polygon
shp_list <- readRDS(here::here("data", "shapefiles", "shp_list.RData"))
# shp_list contains three shapefiles (shp_admin0, shp_admin1, shp_admin2), e.g. if the minimal admin level of an entry is 0 (country level), the shapefile can be found in shp_admin0. If an entry contains more than one place, the were separated into different rows, each has its own polygon.
```

```{r load-incidence}
# load calculated estimated incidence (based on raster) from folder, the raster we have only covers sub-saharan Africa, other places were marked as NA
df_all <- suppressMessages(load_incidence(df_all%>%filter(country_iso3!='DZA'))) %>%
  # add Algeria data back with appropriate columns
  rbind(df_all %>% 
          filter(country_iso3=='DZA') %>% 
          mutate(admin_min_level=0, admin_min='Algeria', inc_calc=NA))
```

```{r aggregate-stratifications}
# variables to keep
keep_vars <- c('region', 'country_iso3', 'admin0', 'sampling_quality', 'cases_min_age', 'cases_min_age_bin', 'surveillance_type', 'cases_dehydrated')

# aggregate stratifications by taking weighted mean
# this will be our main analysis dataset
df <- df_all %>%
  group_by_at(c('study_id', 'study_design', keep_vars, 'diagnostic_test_type', 'diagnostic_test_name')) %>%
  summarize(prop_lab_tested = as.numeric(prop_lab_tested),
            prop_lab_tested = weighted.mean(prop_lab_tested, n_cases_tested, na.rm=T),
            prop_5 = weighted.mean(prop_5, n_cases_tested, na.rm=T),
            prop_15 = weighted.mean(prop_15, n_cases_tested, na.rm=T),
            prop_female = weighted.mean(prop_female, n_cases_tested, na.rm=T),
            prop_vaccinated = weighted.mean(prop_vaccinated, n_cases_tested, na.rm=T),
            prop_antibiotics = weighted.mean(prop_antibiotics, n_cases_tested, na.rm=T),
            prop_severe_dehyd = weighted.mean(prop_severe_dehyd, n_cases_tested, na.rm=T),
            prop_mod_dehyd = weighted.mean(prop_mod_dehyd, n_cases_tested, na.rm=T),
            n_cases_tested = sum(n_cases_tested, na.rm = TRUE),
            n_cases_positive = sum(n_cases_positive, na.rm = TRUE)) %>%
  ungroup() %>%
  # manually set weighted mean for YEM study that uses different proportions for culture and RDT
  mutate(prop_lab_tested = ifelse(study_id==26, 0.6593998, prop_lab_tested))
```

<br>

## Study characteristics

### Figure S1. Data coverage by geography 

Number of observations in the primary dataset at each administrative level by country. Countries with >10 observations displayed as 10.

```{r figS1, fig.height = 10, fig.width = 7}
lt <- df_all %>% 
  # select relevant study-period columns
  dplyr::select(c('study_id', keep_vars,
                  'admin0', 'admin1', 'admin2', 'admin3', 'place_name')) %>%
  unique() %>%
  # only keep location names for lowest admin level
  mutate(admin0 = ifelse(admin1 == '' & admin2 == '' & admin3 == '', admin0, ''),
         admin1 = ifelse(admin2 == '' & admin3 == '', admin1, ''),
         admin2 = ifelse(admin3 == '', admin2, '')) %>%
  # reshape for counting
  reshape2::melt(measure.vars = c('admin0', 'admin1', 'admin2', 'admin3'),
                 id.vars = c('study_id', keep_vars)) %>%
  # largest administrative level by observation
  filter(value != '') %>%
  group_by_at(c('study_id', keep_vars[-which(keep_vars=='admin0')])) %>%
  summarize(largest_admin = min(as.character(variable))) %>%
  ungroup() %>%
  # count observations by admin level
  count(country_iso3, largest_admin) %>% 
  rename(variable = largest_admin, observations = n) %>%
  ungroup()

# plot for each admin level
figS1 <- list()
for (i in 0:3) {
  figS1[[i+1]] <- data_map(lt, shp, ad = paste0('admin', i))
}

cowplot::plot_grid(figS1[[1]], figS1[[2]], figS1[[3]], figS1[[4]],
                   labels = c('A', 'B', 'C', 'D'),
                   ncol = 1)


# # number at each level
# lt %>%
#   group_by(variable) %>%
#   # count observations by admin level
#   summarize(observations = sum(observations)) %>%
#   ungroup() %>%
#   pretty_table()

# # numbers for Haiti
# lt %>%
#   filter(country_iso3 == 'HTI') %>%
#   group_by(variable) %>%
#   # count observations by admin level
#   summarize(observations = sum(observations)) %>%
#   ungroup() %>%
#   pretty_table()
```

<br>

### Figure S2. Data coverage over time

Number of observations in the primary dataset within different time periods. Year represents the year sampling was completed. Excludes 9 observations missing a study end date.

```{r figS2, fig.height = 10, fig.width = 7}
# similar to those above, but instead of stratification by admin level, stratify into 4 time periods (before 2000~2004, 2005~2009, 2010~2014, after 2015)
coverage_time <- df_all %>%
  # select relevant study-period columns
  dplyr::select('study_id', keep_vars, TR) %>%
  unique() %>%
  mutate(time_period = case_when(TR <= as.Date("2004-12-31") ~ "1997~2004",
                                 TR > as.Date("2004-12-31") & TR <= as.Date("2009-12-31") ~ "2005~2009",
                                 TR > as.Date("2009-12-31") & TR <= as.Date("2014-12-31") ~ "2010~2014",
                                 TR > as.Date("2014-12-31") ~ "2015~2022")) %>%
  # if multiple sampling periods within a time period, only report one observation
  dplyr::select(-TR) %>%
  unique() %>%
  # if observations span multiple time periods, just report the end of the study period
  arrange(time_period) %>%
  group_by_at(c('study_id', keep_vars)) %>% 
  mutate(num_dups = n(), 
         dup_id = row_number()) %>% 
  ungroup() %>% 
  mutate(is_duplicated = dup_id > 1) %>%
  filter(is_duplicated==FALSE) %>%
  dplyr::select(-is_duplicated) %>%
  # count by time (study ending time)
  count(country_iso3, time_period) %>% 
  rename(variable = time_period, observations = n) %>%
  ungroup()

# plot for each time period
figS2 <- list()
for (i in c("1997~2004", "2005~2009", "2010~2014", "2015~2022")) {
  figS2[[i]] <- data_map(coverage_time, shp, ad = i)
}

cowplot::plot_grid(figS2[[1]], figS2[[2]], figS2[[3]], figS2[[4]],
                   labels = c('A', 'B', 'C', 'D'),
                   ncol = 1)

# # number at each level
# coverage_time %>%
#   group_by(variable) %>%
#   # count observations by time period
#   summarize(observations = sum(observations)) %>%
#   ungroup() %>%
#   pretty_table()

# # numbers for Haiti
# coverage_time %>%
#   filter(country_iso3 == 'HTI') %>%
#   group_by(variable) %>%
#   # count observations by time period
#   summarize(observations = sum(observations)) %>%
#   ungroup() %>%
#   pretty_table()
```

<br>

### Table 1. Study characteristics

Number of observations with each study characteristic.

```{r tab1}
# prep variables for table
sd <- df %>% 
  # format proportion tested
  mutate(prop_lab_tested = ifelse(prop_lab_tested < 0.05, '0-5',
                                   ifelse(prop_lab_tested >=0.05 & prop_lab_tested < 0.5, '5-50',
                                          ifelse(prop_lab_tested >= 0.5 & prop_lab_tested < 0.95, '50-95', '95+')))) %>%
  # sum up number of tests and sample sizes by observation
  group_by_at(c('study_id', 'study_design', 'prop_lab_tested', keep_vars)) %>%
  summarize(num_tests = length(unique(diagnostic_test_type)),
            n = sum(n_cases_tested)) %>%
  ungroup() %>%
  # format number of tests and sample sizes
  mutate(num_tests = ifelse(num_tests >= 3, '3+', num_tests),
         n = ifelse(n < 10, '1-9', 
                    ifelse(n >=10 & n < 100, '10-99',
                           ifelse(n >= 100 & n < 1000, '100-999', '1000+')))) %>%
  unique() %>%
  dplyr::select(study_design, sampling_quality, prop_lab_tested, num_tests, n) 

# summarize and make table
sd %>%
  summarize_cats() %>%
  pretty_table()

sd %>%
  summarize_cats() %>%
  flextable() %>%
  save_as_docx(path = here::here('code/tables/table1.docx'))
```

<br>

### Table S2. Characteristics of suspected cholera cases reported by each study

```{r tabS2}
# summarize studies with and without covariates
cv <- df %>% 
  dplyr::select(study_id, sampling_quality, country_iso3, surveillance_type,
                prop_5, prop_15, prop_female, prop_mod_dehyd,
                prop_vaccinated, prop_antibiotics, prop_severe_dehyd) %>%
  mutate(prop_5_and_severe_dehyd = ifelse(!is.na(prop_5+prop_severe_dehyd), 'Yes', 'No'),
         prop_5_and_dehyd_and_antibiotics = ifelse(!is.na(prop_5+prop_severe_dehyd+prop_antibiotics), 'Yes', 'No')) %>%
  mutate(prop_5 = ifelse(!is.na(prop_5), 'Yes', 'No'),
         prop_15 = ifelse(!is.na(prop_15), 'Yes', 'No'),
         prop_female = ifelse(!is.na(prop_female), 'Yes', 'No'),
         prop_vaccinated = ifelse(!is.na(prop_vaccinated), 'Yes', 'No'),
         prop_antibiotics = ifelse(!is.na(prop_antibiotics), 'Yes', 'No'),
         prop_mod_dehyd = ifelse(!is.na(prop_mod_dehyd), 'Yes', 'No'),
         prop_severe_dehyd = ifelse(!is.na(prop_severe_dehyd), 'Yes', 'No')) %>%
  unique() %>%
  # drop rows studies 63 and 114 that don't report all covariates
  filter(study_id != 63 | prop_female == 'Yes') %>%
  filter(study_id != 114 | prop_5 == 'Yes') %>%
  # clean up
  dplyr::select(-study_id, -surveillance_type,
                -sampling_quality, -country_iso3)

# summarize and make table
cv %>%
  summarize_cats() %>%
  pretty_table()

cv %>%
  summarize_cats() %>%
  flextable() %>%
  save_as_docx(path = here::here('code/tables/tableS2.docx'))
```

<br>

## *V. cholerae* positivity in unadjusted data

### Figure 2. *Vibrio cholerae* positivity by study methodology and outbreak context

Proportion of suspected cholera cases that were confirmed positive by **A)** diagnostic test type, **B)** quality of sampling methods, where "high" includes all suspected cases or a random or stratified sample and "low" includes convenience or unreported sampling methods, **C)** age minimum in suspected case definition, where "0" indicates that no minimum age was set, and **D)** whether surveillance was initiated in response to an outbreak or whether it was routine surveillance or non-outbreak. Each point is an observation. Boxes represent the mean and interquartile range of positivity for each group. Lines extend from the top and bottom of box to the largest positivity value no further than 1.5 * IQR from the box.

```{r}
cp <- df %>%
  # select cols
  group_by(study_id, sampling_quality, cases_min_age, 
           cases_dehydrated, surveillance_type,
           prop_antibiotics, prop_severe_dehyd,
           country_iso3, diagnostic_test_type) %>%
  # aggregate positivity data
  summarize(n_cases_tested = sum(n_cases_tested),
            n_cases_positive = sum(n_cases_positive)) %>%
  ungroup() %>%
  # percent positive
  mutate(prop_pos = n_cases_positive/n_cases_tested,
         sampling_quality = ifelse(sampling_quality == 'High', 'High quality', 'Low quality'))
```

```{r}
# proportion positive by diagnostic test
f2a <- plot_posrate(cp, 'diagnostic_test_type', num_colors=3)

# cp %>%
#   group_by(diagnostic_test_type) %>%
#   summarize(median = median(prop_pos),
#             N = length(prop_pos),
#             IQR_L = quantile(prop_pos, 0.25),
#             IQR_R = quantile(prop_pos, 0.75)) %>%
#   ungroup %>%
#   pretty_table()

# proportion positive by sampling method
f2b <- plot_posrate(cp, 'sampling_quality', num_colors=3)

# cp %>%
#   group_by(sampling_quality) %>%
#   summarize(median = median(prop_pos),
#             N = length(prop_pos),
#             IQR_L = quantile(prop_pos, 0.25),
#             IQR_R = quantile(prop_pos, 0.75)) %>%
#   ungroup %>%
#   pretty_table()

# # overall
# cp %>%
#   summarize(median = median(prop_pos),
#             N = length(prop_pos),
#             IQR_L = quantile(prop_pos, 0.25),
#             IQR_R = quantile(prop_pos, 0.75)) %>%
#   ungroup %>%
#   pretty_table()
```

```{r}
# proportion positive by case definitions
f2c <- plot_posrate(cp, 'cases_min_age', num_colors=5) + 
  ggtitle('Age minimum in case definition')

# cp %>%
#   group_by(cases_min_age) %>%
#   summarize(median = median(prop_pos),
#             N = length(prop_pos),
#             IQR_L = quantile(prop_pos, 0.25),
#             IQR_R = quantile(prop_pos, 0.75)) %>%
#   ungroup %>%
#   pretty_table()
```

```{r}
# proportion positive by surveillance type
f2d <- plot_posrate(cp, 'surveillance_type', num_colors=3)

# cp %>%
#   group_by(surveillance_type) %>%
#   summarize(median = median(prop_pos),
#             N = length(prop_pos),
#             IQR_L = quantile(prop_pos, 0.25),
#             IQR_R = quantile(prop_pos, 0.75)) %>%
#   ungroup %>%
#   pretty_table()
```

```{r fig2, fig.width = 8, fig.height = 6}
cowplot::plot_grid(f2a, f2b, f2c, f2d,
                   labels = c('A', 'B', 'C', 'D'),
                   nrow = 2)
```


<br>

### Figure S3. *Vibrio cholerae* positivity by incidence and suspected case characteristics

Relationship between reported *V. cholerae* positivity and **A)** proportion of suspected cholera cases tests that were under 5 years of age, **B)** suspected cholera incidence rate per 10,000 at study site, **C)** proportion of suspected cases severely dehydrated, and **D)** proportion of suspected cases on antibiotics prior to testing. Size of the points is proportional to the number of cases tested, and shapes indicate which diagnostic test was used to confirm *V. cholerae* infection. Confidence intervals for Spearman rank correlation coefficients estimated using bootstrapping (nrep=1000). Smoothing method is loess (without weights). In **B)** estimated suspected cholera incidence rates for 2010-2016 (Lessler et al., 2018) were aggregated to the administrative division that best represented each study’s catchment area by dividing the total estimated cholera cases in each area by its estimated population.

```{r}
# prep data
df_cont <- df %>%
  # select cols
  group_by(study_id, country_iso3, diagnostic_test_type,
           study_design, sampling_quality, surveillance_type,
           prop_antibiotics, prop_severe_dehyd,
           cases_min_age, prop_5) %>%
  # aggregate by study-period
  summarize(n_cases_tested = sum(n_cases_tested),
            n_cases_positive = sum(n_cases_positive)) %>%
  ungroup %>%
  # transform variables of interest
  mutate(posrate = n_cases_positive/n_cases_tested)
```

```{r}
# plot relationship between prop under 5 and positivity rates
df_cor <- df_cont %>% 
  dplyr::select(study_id, posrate, sampling_quality, surveillance_type, 
                diagnostic_test_type, cases_min_age, n_cases_tested, prop_5) %>%
  na.omit()

ct <- spearman.ci(df_cor$posrate, df_cor$prop_5)
ct_p <- cor.test(df_cor$posrate, df_cor$prop_5, method = 'spearman')

# plot relationship between prop under 5 and incidence
figS3a <- ggplot(df_cor, aes(y=posrate, x = prop_5)) +
  geom_point(alpha = 0.6, aes(size = n_cases_tested, shape = diagnostic_test_type)) +
  theme_bw() +
  theme(legend.position = 'bottom') +
  annotate('text', x = 0.5, y = 1.03, color = 'darkgreen',
           label = paste0('Spearman rho = ', signif(ct$estimate, 2), 
                          ' (95% Confidence Interval ', signif(ct$conf.int[[1]],2), 
                          ' to ', signif(ct$conf.int[[2]],2), ')')) +
  geom_smooth(method = 'loess',  color='purple')+
  labs(x = 'Proportion under 5', y = 'Proportion positive',
       size = NULL, shape = NULL)
```

```{r}
# plot relationship between incidence and positivity rates
df_cor <- df_all %>% 
  # select cols
  group_by(study_id, country_iso3, admin_min, inc_calc, diagnostic_test_type, 
           sampling_quality, surveillance_type, cases_min_age) %>%
  # aggregate
  summarize(n_cases_tested = sum(n_cases_tested),
            n_cases_positive = sum(n_cases_positive)) %>%
  ungroup %>%
  # transform variables of interest
  mutate(posrate = n_cases_positive/n_cases_tested,
         inc_calc_10000 = inc_calc * 10000) %>%
  na.omit()

ct <- spearman.ci(df_cor$posrate, df_cor$inc_calc_10000)
ct_p <- cor.test(df_cor$posrate, df_cor$inc_calc_10000, method = 'spearman')

# plot relationship between positivity rate and incidence
figS3b <- ggplot(df_cor, aes(y=posrate, x = inc_calc_10000)) +
  geom_point(alpha = 0.6, aes(size = n_cases_tested, shape = diagnostic_test_type)) +
  scale_x_continuous(trans='log10') +
  theme_bw() +
  theme(legend.position = 'bottom') +
  annotate('text', x = 0.28, y = 1.02, color = 'darkgreen',
           label = paste0('Spearman rho = ', signif(ct$estimate, 2), 
                          ' (95% Confidence Interval ', signif(ct$conf.int[[1]],2), 
                          ' to ', signif(ct$conf.int[[2]],2), ')')) +
  geom_smooth(method = 'loess',  color='purple')+
  labs(x = 'Incidence (per 10,000)', y = 'Proportion positive',
       size = NULL, shape = NULL) 
```

```{r}
# plot relationship between proportion on antibiotics and positivity rates
df_cor <- df_cont %>% 
  dplyr::select(study_id, sampling_quality, surveillance_type, cases_min_age,
                diagnostic_test_type, n_cases_tested, posrate, prop_antibiotics) %>%
  na.omit()

ct <- spearman.ci(df_cor$posrate, df_cor$prop_antibiotics)
ct_p <- cor.test(df_cor$posrate, df_cor$prop_antibiotics, method = 'spearman')

# plot relationship between positivity rate and proportion on antibiotics
figS3c <- ggplot(df_cor, aes(y=posrate, x = prop_antibiotics)) +
  geom_point(alpha = 0.6, aes(size = n_cases_tested, shape = diagnostic_test_type)) +
  theme_bw() +
  theme(legend.position = 'bottom') +
  scale_size_continuous(breaks = c(1000, 3000, 5000)) +
  annotate('text', x = 0.23, y = 1.02, color = 'darkgreen',
           label = paste0('Spearman rho = ', signif(ct$estimate, 2), 
                          ' (95% Confidence Interval ', signif(ct$conf.int[[1]],2), 
                          ' to ', signif(ct$conf.int[[2]],2), ')')) +
  geom_smooth(method = 'loess',  color='purple')+
  labs(x = 'Proportion on antibiotics', y = 'Proportion positive',
       size = NULL, shape = NULL) 
```

```{r}
# plot relationship between prop severely dehydrated and positivity rates
df_cor <- df_cont %>% 
  dplyr::select(study_id, sampling_quality, surveillance_type, cases_min_age,
                diagnostic_test_type, n_cases_tested, posrate, prop_severe_dehyd) %>%
  na.omit()

ct <- spearman.ci(df_cor$posrate, df_cor$prop_severe_dehyd)
ct_p <- cor.test(df_cor$posrate, df_cor$prop_severe_dehyd, method = 'spearman')

# plot relationship between positivity rate and prop severely dehydrated
figS3d <- ggplot(df_cor, aes(y=posrate, x = prop_severe_dehyd)) +
  geom_point(alpha = 0.6, aes(size = n_cases_tested, shape = diagnostic_test_type)) +
  theme_bw() +
  theme(legend.position = 'bottom') +
  scale_size_continuous(breaks = c(100, 300, 500)) +
  annotate('text', x = 0.45, y = 1.02, color = 'darkgreen',
           label = paste0('Spearman rho = ', signif(ct$estimate, 2), 
                          ' (95% Confidence Interval ', signif(ct$conf.int[[1]],2), 
                          ' to ', signif(ct$conf.int[[2]],2), ')')) +
  geom_smooth(method = 'loess',  color='purple')+
  labs(x = 'Proportion severely dehydrated', y = 'Proportion positive',
       size = NULL, shape = NULL) 
```

```{r figS3, fig.width = 10, fig.height = 10}
cowplot::plot_grid(figS3a, figS3b, figS3d, figS3c,
                   nrow = 2,
                   labels = c('A', 'B', 'C', 'D'))
```

<br>

## Adjusted underlying *V. cholerae* positivity

```{r jags-validation-data}
# Re-create dataset using validation data from Fig 2, Table 4, and text of Debes et al. 2021
# https://www.ncbi.nlm.nih.gov/pmc/articles/PMC8176501/
df_ken <- rbind(
  data.frame(id = 1:8, culture=1, pcr=0, rdt=1),
  data.frame(id = 1:69, culture=1, pcr=1, rdt=1),
  data.frame(id = 1:2, culture=0, pcr=1, rdt=1),
  data.frame(id = 1:2, culture=0, pcr=1, rdt=0),
  data.frame(id = 1:149, culture=0, pcr=0, rdt=0)
)
df_ken$id <- NULL

# Re-create dataset using validation data from Table 2 and Fig 3 of Sayeed et al. 2018
# The results for Cholkit and Crystal VC are the same comapred to the other tests
# https://journals.plos.org/plosntds/article?id=10.1371/journal.pntd.0006286
df_bgd <- rbind(
  data.frame(id = 1:15, culture=1, pcr=1, rdt=1),
  data.frame(id = 1:6, culture=0, pcr=1, rdt=1),
  data.frame(id = 1:4, culture=1, pcr=0, rdt=1),
  data.frame(id = 1:5, culture=0, pcr=0, rdt=1),
  data.frame(id = 1:47, culture=0, pcr=0, rdt=0)
)
df_bgd$id <- NULL

# Validation data from Table 1 of Ontweka et al. 2016 PLOS ONE
# https://journals.plos.org/plosone/article?id=10.1371/journal.pone.0168257
df_ssd <- read_xlsx(here::here('data', 'raw_data', 'pone.0168257.s002.xlsx')) %>%
  dplyr::select(`...12`, `...14`, `...9`) 

names(df_ssd) <- c('culture', 'pcr', 'rdt')
df_ssd <- df_ssd[-c(1,2),]

df_ssd <- df_ssd %>%
  mutate(culture = ifelse(culture=='Negative', 0, 1),
         rdt = as.numeric(rdt),
         rdt = ifelse(rdt==2, 1, rdt),
         pcr = as.numeric(pcr)) %>%
  na.omit()

# Validation data from Mwaba et al. 2018
# https://onlinelibrary.wiley.com/doi/full/10.1111/tmi.13084
df_zmb_pcr <- read_xlsx(here::here('data', 'raw_data', 'Lusaka_2016_PCR.xlsx')) %>%
 dplyr::select(Sample, `Final result`) %>%
 na.omit() %>%
 mutate(`Final result` = ifelse(`Final result` == '+', 1, 0))

df_zmb_rdt <- read_xlsx(here::here('data', 'raw_data', 'Lusaka_2016_RDT.xlsx'),
                       range = 'C4:L237') %>%
 # Included in the paper
 dplyr::filter(Include==1) %>%
 mutate(Sample = as.numeric(gsub('o', '', ID))) %>%
 mutate(`Direct RDT` = ifelse(`APW RDT` == '+' | `Direct RDT` == 'Pos', 1, 0),
        Culture = ifelse(Culture == '+' | Culture == 'Pos', 1, 0))

df_zmb <- merge(df_zmb_rdt%>%dplyr::select(Sample, Culture, `Direct RDT`),
               df_zmb_pcr) %>%
 dplyr::select(Culture, `Final result`, `Direct RDT`)

names(df_zmb) <- c('culture', 'pcr', 'rdt')
rm(df_zmb_pcr, df_zmb_rdt)

# create parent dataset and vector with study label
df_val <- rbind(df_ken, df_bgd, 
                df_ssd, df_zmb
                )
val_id <- c(rep(1, nrow(df_ken)),
            rep(2, nrow(df_bgd)),
            rep(3, nrow(df_ssd)),
            rep(4, nrow(df_zmb))
            )
```

```{r jags-model-results}
# file to save to
jags_est_file <- here::here('data', 'generated_data', 'sens_spec_estimates', 
                            paste0('sens-spec-', jags_run_id, '.rds'))
jags_fit <- readRDS(jags_est_file)

# randomly select draws to run in stan
se_draws <- jags_fit$BUGSoutput$sims.list$mu_se
sp_draws <- jags_fit$BUGSoutput$sims.list$mu_sp
colnames(se_draws) <- colnames(sp_draws) <- c('Culture', 'PCR', 'RDT')

# also save study-specific estimates
# first index is draw, second is test, third is study
se_study <- jags_fit$BUGSoutput$sims.list$se
sp_study <- jags_fit$BUGSoutput$sims.list$sp
```

### Table S3. Estimated sensitivity and specificity of each diagnostic test

Estimate is median sensitivity and specificity pooled across four studies that reported results for all diagnostics tests, as described in Methods. Parentheses show 95% Credible Interval.

```{r tabS3}
# extract sensitivity and specificity estimates
se_sp_est <- jags_fit$BUGSoutput$summary[2:7, c('2.5%', '50%', '97.5%')]
se_sp_est <- round(se_sp_est, 3)*100

# table S2
tabS3 <- data.frame('Measure' = c(rep('Sensitivity', 3), rep('Specificity', 3)),
                    'Test' = rep(c('Culture', 'PCR', 'RDT'), 2),
                    'Estimate' = paste(se_sp_est[,2],'(',se_sp_est[,1],'-',se_sp_est[,3],')'))

names(tabS3) <- c('Measure', 'Test', 'Estimate (%)')
pretty_table(tabS3)

tabS3 %>%
  flextable() %>%
  save_as_docx(path = here::here('code/tables/tableS3.docx'))
```

```{r epi-data-stan}
# set covariates
covs <- c('sampling_quality', 'cases_min_age_bin', 'cases_dehydrated', # adjust for these
          'surveillance_type') # examine differences by these (and age categories in separate analysis)

# positivity rates from meta-analysis primary dataset
sr_dat <- df %>%
  group_by_at(c('study_id', 'country_iso3', 'region', covs,
                'diagnostic_test_type', 'diagnostic_test_name')) %>%
  summarize(n_cases_tested = sum(n_cases_tested),
            n_cases_positive = sum(n_cases_positive)) %>%
  ungroup()

# cast number tested by test type
test_dat <- sr_dat %>%
  reshape2::dcast(as.formula(paste0(paste0(c('study_id', 'country_iso3', 'region', covs), 
                                           collapse = '+'), 
                                    '~ diagnostic_test_type')),
                  value.var = 'n_cases_tested', fill = 0)

# cast number positive by test type
pos_dat <- sr_dat %>%
  reshape2::dcast(as.formula(paste0(paste0(c('study_id', 'country_iso3', 'region', covs), 
                                           collapse = '+'), 
                                    '~ diagnostic_test_type')),
                  value.var = 'n_cases_positive', fill = 0)

# add random effect label by observation
test_dat <- test_dat %>% mutate(study_lab = 1:nrow(test_dat))
pos_dat <- pos_dat %>% mutate(study_lab = 1:nrow(test_dat))
```

```{r data by covariate strata}
strata1_dat <- sr_dat %>%
  group_by(cases_min_age_bin, sampling_quality) %>%
  summarize(weighted_mean = round(sum(n_cases_positive)/sum(n_cases_tested)*100,1),
            median = round(median(n_cases_positive/n_cases_tested)*100,1)) %>%
  ungroup() %>%
  arrange(sampling_quality, cases_min_age_bin)

strata4_dat <- sr_dat %>%
  group_by(sampling_quality, surveillance_type) %>%
  summarize(weighted_mean = round(sum(n_cases_positive)/sum(n_cases_tested)*100,1),
            median = round(median(n_cases_positive/n_cases_tested)*100,1)) %>%
  ungroup() %>%
  arrange(sampling_quality, surveillance_type)
```

```{r}
mod_ests <- data.frame(run_id = NA,
                      stan_id = NA,
                      mean = NA,
                      lower = NA,
                      upper = NA,
                      row.names = NULL)

file_names <- list.files(here::here('data', 'generated_data', 'adjusted_positivity_rates'))
file_names <- file_names[which(file_names %like% 'mod1.rds|mod1-sa.rds|mod2.rds|mod3.rds')]

for (i in file_names) {
  
  posrate <- readRDS(here::here('data', 'generated_data', 'adjusted_positivity_rates', i))
  model_name <- gsub('posrate-|-full|-d100|\\.rds', '', i)
  
  # save alpha results
  mod_ests <- rbind(mod_ests,
                   data.frame(run_id = model_name,
                              stan_id = 'alpha',
                              mean = mean(inv.logit(posrate$alpha$alpha), na.rm = T),
                              lower = quantile(inv.logit(posrate$alpha$alpha), probs = .025, na.rm = T),
                              upper = quantile(inv.logit(posrate$alpha$alpha), probs = .975, na.rm = T),
                              row.names = NULL
                              )
                   )
  
  # save beta coefficients
  for (c in names(posrate$beta)) {
    if (c != '(Intercept)') {
      mod_ests <- rbind(mod_ests,
                       data.frame(
                         run_id = model_name,
                         stan_id = c,
                         mean = mean(posrate[['beta']][[c]], na.rm = T),
                         lower = quantile(posrate[['beta']][[c]], probs = .025, na.rm = T),
                         upper = quantile(posrate[['beta']][[c]], probs = .975, na.rm = T),
                         row.names = NULL
                       )
      )
    }
  }
  
}

```

```{r stratify}

# get the proportion of studies by age category
# note: the function integrates over RE, post-stratifies, and stratifies, 
#       which is why we pull these, but in the paper we only present stratified results 
#       because they are more meaningful
cats_mod2 <- obs_by_cat(df, c('sampling_quality', 'cases_min_age_bin'))
cats_mod4 <- obs_by_cat(df, c('sampling_quality', 'surveillance_type'))

# get overall Vc proportion positive adjusted by test performance, integrating over random effects
pos_mod1 <- stratify('mod1', data.frame(alpha = 1, n = 1, prop = 1))[[1]]
pos_mod1_sa <- stratify('mod1-sa', data.frame(alpha = 1, n = 1, prop = 1))[[1]]

# get overall Vc proportion positive unadjusted by test performance, integrating over random effects
pos_mod1_unadj <- stratify('mod1-unadj', data.frame(alpha = 1, n = 1, prop = 1))[[1]]

# post-stratify to get overall Vc proportion positive by strata
pos_mod2 <- stratify('mod2', cats_mod2)[[2]]
pos_mod4 <- stratify('mod4', cats_mod4)[[2]]

# save test-unadjusted post-stratified positivity to mod_est data frame
mod_ests <- rbind(mod_ests,
                  data.frame(run_id = 'mod1',
                             stan_id = 'pos',
                             mean = mean(pos_mod1_unadj$pos, na.rm = T),
                             lower = quantile(pos_mod1_unadj$pos, probs = .025, na.rm = T),
                             upper = quantile(pos_mod1_unadj$pos, probs = .975, na.rm = T),
                             row.names = NULL
                             )
                  )

# save test-adjusted post-stratified positivity to mod_est data frame
mod_ests <- rbind(mod_ests,
                  data.frame(run_id = 'mod1-adj',
                             stan_id = 'pos',
                             mean = mean(pos_mod1$pos, na.rm = T),
                             lower = quantile(pos_mod1$pos, probs = .025, na.rm = T),
                             upper = quantile(pos_mod1$pos, probs = .975, na.rm = T),
                             row.names = NULL
                             )
                  )

# save sensitivity analysis of test-adjusted post-stratified positivity to mod_est data frame
mod_ests <- rbind(mod_ests,
                  data.frame(run_id = 'mod1-sa',
                             stan_id = 'pos',
                             mean = mean(pos_mod1_sa$pos, na.rm = T),
                             lower = quantile(pos_mod1_sa$pos, probs = .025, na.rm = T),
                             upper = quantile(pos_mod1_sa$pos, probs = .975, na.rm = T),
                             row.names = NULL
                             )
                  )

# save estimates for high-quality sampling, no min age stratum
mod_ests <- rbind(mod_ests,
                  data.frame(run_id = 'strata-high-age0',
                             stan_id = 'pos',
                             mean = pos_mod2[1, 'mean'],
                             lower = pos_mod2[1, 'lower'],
                             upper = pos_mod2[1, 'upper'],
                             row.names = NULL
                             )
                  )

# save estimates for high-quality sampling, any min age stratum
mod_ests <- rbind(mod_ests,
                  data.frame(run_id = 'strata-high-age1',
                             stan_id = 'pos',
                             mean = pos_mod2[2, 'mean'],
                             lower = pos_mod2[2, 'lower'],
                             upper = pos_mod2[2, 'upper'],
                             row.names = NULL
                             )
                  )

# save estimates for high-quality sampling, non-outbreak setting
mod_ests <- rbind(mod_ests,
                  data.frame(run_id = 'strata-high-nonoutbreak',
                             stan_id = 'pos',
                             mean = pos_mod4[1, 'mean'],
                             lower = pos_mod4[1, 'lower'],
                             upper = pos_mod4[1, 'upper'],
                             row.names = NULL
                             )
                  )

# save estimates for high-quality sampling, any min age stratum
mod_ests <- rbind(mod_ests,
                  data.frame(run_id = 'strata-high-outbreak',
                             stan_id = 'pos',
                             mean = pos_mod4[2, 'mean'],
                             lower = pos_mod4[2, 'lower'],
                             upper = pos_mod4[2, 'upper'],
                             row.names = NULL
                             )
                  )

# tidy results
mod_ests <- mod_ests %>%
  drop_na() %>%
  mutate(mean=ifelse(stan_id == 'pos', round(mean*100,1), mean),
         lower=ifelse(stan_id == 'pos', round(lower*100,1), lower),
         upper=ifelse(stan_id == 'pos', round(upper*100,1), upper))
```

<br>

### Figure S4. Posterior distributions of *V. cholerae* positivity

Posterior distributions of *V. cholerae* positivity estimated using the random-effects model corresponding to results in Table S4. A) Unadjusted. B) Adjusted for test performance. C) Adjusted for test performance, sensitivity analysis shifting prior on alpha from Normal(0,2) as in A-B to Normal(0.9,2). On the left, prior (green) and posterior distribution (purple) of the global intercept are shown in logit space. On the right, histograms of estimated *V. cholerae* positivity.

```{r figS4, fig.width=7, fig.height=9}
# distributions of alpha
posrate <- readRDS(here::here('data', 'generated_data', 'adjusted_positivity_rates',
                              paste0('posrate-mod1.rds')))
posrate_unadj <- readRDS(here::here('data', 'generated_data', 'adjusted_positivity_rates',
                               paste0('posrate-mod1-unadj.rds')))
posrate_sa <- readRDS(here::here('data', 'generated_data', 'adjusted_positivity_rates',
                               paste0('posrate-mod1-sa.rds')))

s4aL <- plot_prior_post(posrate_unadj$alpha$alpha, 
                'logit(global intercept)',
                arg1=0, arg2=2, dprior='dnorm') +
  ggtitle('Unadjusted')

s4bL <- plot_prior_post(posrate$alpha$alpha, 
                'logit(global intercept)',
                arg1=0, arg2=2, dprior='dnorm') +
  ggtitle('Adjusted for test performance')

s4cL <- plot_prior_post(posrate_sa$alpha$alpha, 
                'logit(global intercept)',
                arg1=0.9, arg2=2, dprior='dnorm') +
  ggtitle('Adjusted for test performance, sensitivity analysis')


# distributions of V. cholerae positivity
s4aR <- ggplot() +
  geom_histogram(aes(pos_mod1_unadj$pos))+
  xlim(c(0,1)) +
  theme_classic() +
  xlab('V. cholerae positivity') + ggtitle('  ')

s4bR <- ggplot() +
  geom_histogram(aes(pos_mod1$pos))+
  xlim(c(0,1)) +
  theme_classic() +
  xlab('V. cholerae positivity') + ggtitle('  ')

s4cR <- ggplot() +
  geom_histogram(aes(pos_mod1_sa$pos))+
  xlim(c(0,1)) +
  theme_classic() +
  xlab('V. cholerae positivity') + ggtitle('  ')


# plot
cowplot::plot_grid(s4aL, s4aR,
                   s4bL, s4bR,
                   s4cL, s4cR,
                   labels = c('A', '', 'B', '', 'C', ''), ncol = 2)
```

<br>

### Table S4. Estimated underlying *V. cholerae O1/O139* positivity

“Unadjusted” is mean V. cholerae positivity (95% credible interval) from random effects meta-analysis without adjustments for test performance. “Adjusted” refers to V. cholerae estimates additionally adjusted for test performance, where the primary analysis includes a Normal(0,2) prior on the global intercept and a sensitivity analysis includes the prior shifted to Normal(0.9,2). “Stratified estimate for high quality…” corresponds to post-stratified estimates of V. cholerae positivity for studies that use high quality sampling methods and whether an age minimum was set in the suspected case definition, as well as whether surveillance was initiated in response to an outbreak.

```{r tabS4}
# mean adjusted proportion positive
pr2 <- mod_ests %>%
  filter(run_id %in% c('mod1', 'mod1-adj', 'mod1-sa',
                       'strata-high-age0', 'strata-high-age1',
                       'strata-high-nonoutbreak', 'strata-high-outbreak'), 
         stan_id == 'pos') %>%
  arrange(run_id) %>%
  dplyr::select(lower, mean, upper)

# mean adjusted proportion positive
pr2 <- pr2 %>%
  mutate(variable = c('Unadjusted', 
                      'Adjusted\nfor test\nperformance',
                      'Adjusted\nfor test\nperformance\nshift prior',
                      'Stratum:\nhigh quality,\nno min age',
                      'Stratum:\nhigh quality,\nany min age\n',
                      'Stratum:\nhigh quality,\nnon-outbreak',
                      'Stratum:\nhigh quality,\noutbreak\n')) %>%
  mutate(variable = factor(variable, levels = c('Unadjusted', 
                      'Adjusted\nfor test\nperformance',
                      'Adjusted\nfor test\nperformance\nshift prior',
                      'Stratum:\nhigh quality,\nno min age',
                      'Stratum:\nhigh quality,\nany min age\n',
                      'Stratum:\nhigh quality,\nnon-outbreak',
                      'Stratum:\nhigh quality,\noutbreak\n')))

# table S4
tabS4 <- data.frame('Version' = c('Unadjusted', 
                                 'Adjusted for test performance',
                                 'Adjusted for test performance, prior on alpha shifted',
                                 'Stratified estimate for high quality sample with no known age restriction',
                                 'Stratified estimate for high quality sample with any age restriction',
                                 'Stratified estimate for high quality sample during non-outbreak surveillance',
                                 'Stratified estimate for high quality sample during outbreak surveillance'),
                   'Positivity rate' = paste(pr2[,2],'(',pr2[,1],'-',pr2[,3],')'))

names(tabS4) <- c('Version', 'Positivity (%)')
pretty_table(tabS4)

tabS4 %>%
  flextable() %>%
  save_as_docx(path = here::here('code/tables/tableS4.docx'))
```

<br>

### Figure 3. Estimated underlying *V. cholerae* positivity

**A)** Posterior distributions of pooled percent sensitivity and specificity of culture (top), PCR (middle), and RDT (bottom) for detecting V. cholerae O1O139 infections in suspected cholera cases. Dashed lines represent mean values of each distribution. **B)** "Unadjusted" is mean V. cholerae positivity (95% credible interval) from random effects meta-analysis without adjustments for test performance. "Adjusted for test performance" is estimated mean V. cholerae positivity (95% credible interval), adjusted for sensitivity/specificity of the tests. High-quality stratified estimates corresponds to post-stratified estimates of V. cholerae positivity for studies that use high quality sampling methods and whether an age minimum was set in the suspected case definition, as well as whether surveillance was initiated in response to an outbreak.

```{r fig3, fig.width = 9, fig.height = 5}
# set colors
pal <- c('grey30', brewer.pal(n=6, name='Dark2'))

# update data frame for plotting
pr3 <- pr2 %>% 
  filter(variable != "Adjusted\nfor test\nperformance\nshift prior") %>%
  mutate(facet = c(rep('Across all settings',2), 
                   rep('High quality, age strata',2),
                   rep('High quality, outbreak strata',2)))

# positivity plot
f3b <- ggplot(pr3) +
          geom_point(aes(x = variable, y = mean, color = variable), size = 2) +
          geom_errorbar(aes(x = variable, ymin = lower, ymax = upper, color = variable), width = 0.3) +
          scale_color_manual(values = pal) +
          theme_bw() +
          theme(legend.position = 'none') +
          ylim(0,100) +
          ylab('Positivity (%)') + xlab(NULL) +
          facet_wrap('facet', nrow = 1, scales = 'free_x') +
          ggtitle('V. cholerae positivity')

# posterior of sensitivity and specificity
pal <- brewer.pal(11, 'PRGn')

se_long <- melt(se_draws) %>%
  mutate(measure = 'Sensitivity')
sp_long <- melt(sp_draws) %>%
  mutate(measure = 'Specificity')

long <- rbind(se_long, sp_long)

# medians
ss_meds <- long %>% 
  group_by(Var2, measure) %>%
  summarize(value = median(value)*100) %>%
  ungroup()

f3a <- ggplot(long) + 
  geom_vline(data=ss_meds%>%filter(measure == 'Sensitivity'), aes(xintercept = value), 
             color = pal[9], linetype = 'dashed') +
  geom_vline(data=ss_meds%>%filter(measure == 'Specificity'), aes(xintercept = value), 
             color = pal[2], linetype = 'dashed') +
  geom_density(aes(value*100, color = measure)) + 
  theme_classic() +
  facet_wrap('Var2', ncol = 1) +
  xlim(0,100) +
  xlab(NULL) + ylab('Posterior Density') + 
  scale_color_manual(values = c(pal[9], pal[2]),
                     name = NULL, 
                     labels = c('Sensitivity', 'Specificity')) +
  theme(legend.position = 'bottom',
        legend.background=element_blank())

cowplot::plot_grid(f3a, f3b,
                   labels = c('A', 'B'),
                   ncol = 2, rel_widths = c(0.5, 1))
```

<br>

### Figure 4. Forest plot of study estimates and underlying positivity

Black points indicate mean study-level underlying positivity and 95% Credible Interval (CI). Teal, orange, and purple points indicate the proportion positive reported by study for culture, PCR, and RDT, respectively, and corresponding error bars indicate 95% confidence interval for a binomial probability, estimated with the normal approximation. Studies are labeled by country ISO3 code, whether they used high quality sampling methods, and whether a minimum age was set in the suspected cholera case definition. Studies are split into outbreak and non-outbreak for ease of interpretation.

```{r}
# underlying positivity rate by study
df_p <- posrate$p

# get mean and 95% CI by study
study_est <- data.frame(matrix(nrow=0, ncol=9))
names(study_est) <- c('study_id', 'country_iso3', 'sampling_quality', 'cases_min_age_bin',
                      'surveillance_type', 'mean', 'lower', 'upper')
  
for (i in 1:ncol(df_p)) {
  study_est <- rbind(study_est,
                     data.frame(study_id = test_dat[i, 'study_id'],
                                country_iso3 = test_dat[i, 'country_iso3'],
                                sampling_quality = test_dat[i, 'sampling_quality'],
                                cases_min_age = test_dat[i, 'cases_min_age_bin'],
                                surveillance_type = test_dat[i, 'surveillance_type'],
                                mean = mean(df_p[, i][[1]], na.rm = T),
                                lower = quantile(df_p[, i][[1]], probs = .025, na.rm = T),
                                upper = quantile(df_p[, i][[1]], probs = .975, na.rm = T)))
}

# add original study data
study_est <- left_join(study_est, test_dat) %>%
  dplyr::select(-study_lab) %>%
  # proportion positive by test
  mutate(Culture_p = pos_dat$Culture/test_dat$Culture,
         PCR_p = pos_dat$PCR/test_dat$PCR,
         RDT_p = pos_dat$RDT/test_dat$RDT) %>%
  group_by(study_id, country_iso3, sampling_quality, cases_min_age_bin, surveillance_type,
           mean, upper, lower, Culture_p, PCR_p, RDT_p) %>%
  # binomial confidence intervals and variance for proportions
  summarize(Culture_lower = binomial_ci(Culture_p, Culture)[[1]],
            Culture_upper = binomial_ci(Culture_p, Culture)[[2]],
            PCR_lower = binomial_ci(PCR_p, PCR)[[1]],
            PCR_upper = binomial_ci(PCR_p, PCR)[[2]],
            RDT_lower = binomial_ci(RDT_p, RDT)[[1]],
            RDT_upper = binomial_ci(RDT_p, RDT)[[2]],
            Culture_v = prop_var(Culture_p, Culture),
            PCR_v = prop_var(PCR_p, PCR),
            RDT_v= prop_var(RDT_p, RDT),
            # maximum variance across studies that use multiple tests
            vi = max(c(Culture_v, PCR_v, RDT_v), na.rm=T)) %>%
  ungroup()
```

```{r i2, message = TRUE}
# calculate tau2, between-study heterogeneity or variance of the random effects by study
tau2 <- quantile(inv.logit(posrate$sigma_re$sigma_re), c(0.025, 0.5, 0.975))

# grab v, within-study sampling variance, dropping the study that reported 0 positives
vi <- study_est%>%filter(vi!=0)%>%dplyr::select(vi)

# calculate i2
# https://www.metafor-project.org/doku.php/tips:i2_multilevel_multivariate#:~:text=For%20a%20standard%20random%2Deffects,ith%20i%20t
k <- nrow(test_dat)-1 # dropped 1 study with 0 positives
sum_wi <- sum(1/vi[[1]])
sum_wi2 <- sum((1/vi[[1]])^2)
v <- ((k-1)*sum_wi)/(sum_wi^2-sum_wi2)
i2 <- 100*tau2/(tau2+v)

message('I2: ', paste0(round(i2,5), sep = ', '), '; tau2: ', paste0(round(tau2,5), sep = ', '))
```

```{r fig4, fig.height = 9, fig.width = 9}
# plot from lowest to highest mean positivity
setorderv(study_est, 'mean')

# create study labels
study_est <- study_est %>%
  mutate(study_lab = paste0(country_iso3, ' - ',
                            ifelse(sampling_quality=='High', 'High - ', 'Low  - '),
                            cases_min_age_bin))

# forest plot for outbreak surveillance
out <- forest_plot(study_est %>% 
                     filter(surveillance_type=='Outbreak') %>%
                     mutate(id = 1:nrow(study_est %>% filter(surveillance_type=='Outbreak')))) +
  ggtitle('Outbreak surveillance')

# forest plot for non-outbreak surveillance
nonout <- forest_plot(study_est %>% 
                        filter(surveillance_type=='Non-outbreak') %>%
                        mutate(id = 1:nrow(study_est %>% filter(surveillance_type=='Non-outbreak')))) +
  ggtitle('Non-outbreak surveillance')

# plot together
cowplot::plot_grid(nonout, out) 

# look at unadjusted study estimates by stata
strat_est <- study_est %>%
  group_by(sampling_quality, cases_min_age_bin) %>%
    summarize(mean = round(mean(mean)*100,1),
              lower = round(mean(lower)*100,1),
              upper = round(mean(upper)*100,1)) %>%
    ungroup()
```

<br>

## Factors associated with variation in *V. cholerae* positivity

### Table S5. Odds of *V. cholerae* positivity by age and outbreak context

Odds that a suspected cholera case seeking testing or care has a true _V. cholerae_ O1/O139 infection with low sampling quality compared to high sampling quality, with any minimum age set in suspected case definition, and with surveillance initiated in response to an outbreak compared to non-outbreak surveillance (i.e., routine or post-vaccination surveillance).

```{r tabS5}
# mean coefficients
c1 <- mod_ests %>%
  filter(run_id %in% c('mod3'),
         stan_id == 'sampling_qualityLow' | stan_id == 'cases_min_age_bin' | stan_id == 'surveillance_typeOutbreak') %>%
  dplyr::select(lower, mean, upper) %>%
  round(2) %>%
  mutate(variable = c('Low sampling quality',
                      'Minimum age in\ncase definition',
                      'Outbreak surveillance'))

# table S5
tabS5 <- data.frame('Variable' = c('Low sampling quality',
                                  'Minimum age in case definition',
                                  'Outbreak surveillance'),
                   'Odds ratio' = paste(c1[,2],'(',c1[,1],'-',c1[,3],')'))

names(tabS5) <- c('Variable', 'Odds ratio')
pretty_table(tabS5)

tabS5 %>%
  flextable() %>%
  save_as_docx(path = here::here('code/tables/tableS5.docx'))
```

